<?php/* Template Name: Post Space */session_start();global $wpdb;$user_id=get_current_user_id();if(!$user_id){    wp_safe_redirect(home_url().'/login/');    exit();}if(!is_activated_post()){    wp_safe_redirect(site_url().'/post-packages/');    exit();}$err_msg = '';$suc_msg = '';$war_msg = '';//$o_state = array();//$d_state = array();if(isset($_REQUEST['post_id'])){    if(!is_current_user_spaces($_REQUEST['post_id'], 'wp_spaces')){        wp_safe_redirect(home_url().'/dashboard/');        exit();    }    $get_records = $wpdb->get_results("SELECT * FROM wp_spaces WHERE id_space = ".$_REQUEST['post_id'], ARRAY_A);    if(!empty($get_records)){        foreach ($get_records as $get_record) {             extract($get_record);        }        $o_state = explode(',', $o_state);        $d_state = explode(',', $d_state);    }}if(isset($_POST['post_space_now'])){    $o_date = str_replace('-', '/', esc_sql($_POST['o_date']));    $d_date = str_replace('-', '/', esc_sql($_POST['d_date']));    $space_available = esc_sql($_POST['space_available']);    $trailer_size = esc_sql($_POST['trailer_size']);    $o_state = $_POST['o_state'];	    $d_state = $_POST['d_state'];    $comments = esc_sql($_POST['comments']);    if(isset($_POST['purchased_package_id'])){        $purchased_package_id = esc_sql($_POST['purchased_package_id']);    }    if(empty($o_date)){        $err_msg .= "Please enter from date.";    }    else if(empty($d_date)){        $err_msg .="Please select to date";    }    else if($d_date < $o_date){        $err_msg .="To date should come after from date.";    }    else if(empty($o_state)){        $err_msg .="Please select at least one origin state.";    }    else if(count($o_state) > 3){        $err_msg .="You can select upto 3 origin state.";    }    else if(empty($d_state)){        $err_msg .="Please select at least one destination state.";    }    if($err_msg == ''){        $post_space_arr = array(            'userid' => $user_id,            'o_state' => implode(',', $o_state),            'o_date' => date('Y-m-d', strtotime($o_date)),            'd_state' => implode(',', $d_state),            'd_date' => date('Y-m-d', strtotime($d_date)),            'comments' => $comments,            'space_available' => $space_available,            'trailer_size' => $trailer_size,            'sequence' => NULL,            'post_type' => $_POST['post_type'],            'post_date'=>date('Y-m-d H:i:s')        );        if(!empty($_POST['id']) && is_numeric($_POST['id'])){            $post_space = $wpdb->update('wp_spaces', $post_space_arr, array('id_space' => $_POST['id']));            if(is_numeric($post_space)){                $_SESSION['show_msg'] = 'Post has been updated successfully.';                wp_safe_redirect(site_url().'/view-open-post/');                exit();            }        }else{            $sql = "    SELECT                             pm.*, pa.*                         FROM                             wp_post_package_master AS pm                         INNER JOIN                             wp_user_postaccount AS pa                         ON                             pm.id_post_package = pa.id_package                         WHERE                             pa.id = $purchased_package_id                        AND                             pa.expiry_date >= CURDATE()                    ";            $get_expiry_posts = $wpdb->get_results($sql, ARRAY_A);            if(!empty($get_expiry_posts)){                foreach ($get_expiry_posts as $get_expiry_post) {                    $post_expiry_date = date('Y-m-d', strtotime('+'.$get_expiry_post['expiry_per_post'].'day'));                    $post_count = $get_expiry_post['post_count'];                }            }            array_push_associative($post_space_arr, array('post_expiry_date' => $post_expiry_date, 'purchased_package_id' => $purchased_package_id));            $post_space = $wpdb->insert('wp_spaces',$post_space_arr);            if($post_space){                $post_count = $post_count-1;                if($wpdb->update('wp_user_postaccount', array('post_count' => $post_count), array('id' => $purchased_package_id))){                    $o_state = NULL;		                    $o_date = NULL;                    $d_state = NULL;                    $d_date = NULL;                    $space_available = NULL;                    $trailer_size = NULL;                    $comments = NULL;                    $_SESSION['show_msg'] = 'Post has been submitted successfully.';                    wp_safe_redirect(site_url().'/view-open-post/');                    exit();                }            }        }    }												}get_header();?><script type="text/javascript">$(function() {    $( ".datepicker" ).datepicker({        showOn: "button",        buttonImage: "<?php echo get_template_directory_uri();?>/images/img_3.png",        buttonImageOnly: true,        dateFormat: "mm-dd-yy"    });});</script><div class="ctn">    <!--contain-->    <div class="contain_main">        <div class="ctn_in">            <h1>SPACE READY FROM</h1>            <div class="clear"></div>            <form action="" method="post" name="post_space" id="post_space">                <p id="err_msgs" class="<?php if(!empty($err_msg)){echo 'err_msg';}else if(!empty($war_msg)){echo 'war_msg';}else{echo 'suc_msg';}?>">                    <?php                         if(!empty($err_msg)){echo $err_msg;}                         else if(!empty($war_msg)){echo $war_msg;}                         else{echo $suc_msg;}                    ?>                 </p>                <div class="post_space">                    <div class="post_space_in">                    	<div class="post_div_btm_area">                            <p><label>From Date</label><input name="o_date" id="o_date" autocomplete="off" readonly type="text" class="pst_fld post_loads_txtfld3 datepicker" value="<?php if(($o_date)){ echo date('m-d-Y', strtotime($o_date));}?>"></p>                            <p><label>To Date</label><input name="d_date" id="d_date" autocomplete="off" readonly type="text" class="pst_fld post_loads_txtfld3 datepicker" value="<?php if(($d_date)){ echo date('m-d-Y', strtotime($d_date));}?>"></p>                            <p>                             	<label>Space Available</label>                            	<select name="space_available" id="space_available" class="state_table_bottom_select_box_pst post_loads_txtarea">                                    <?php                                        $i = 200;                                        while($i <= 4000){?>                                            <option value="<?php echo $i;?>" <?php if($space_available == $i){echo "selected='selected'";}?>><?php echo $i;?> c.f.</option>                                    <?php                                            $i = $i + 100;                                        }                                    ?>                                </select>                             </p>                             <p>                             	<label>Trailer Size</label>                            	<select name="trailer_size" id="trailer_size" class="state_table_bottom_select_box_pst post_loads_txtarea">                                    <?php                                        $i = 4000;                                        while($i <= 4500){?>                                            <option value="<?php echo $i;?>" <?php if($trailer_size == $i){echo "selected='selected'";}?>><?php echo $i;?> c.f.</option>                                    <?php                                            $i = $i + 100;                                        }                                    ?>                                </select>                             </p>                        </div>                    </div>                </div>                <div class="post_space">                <div class="post_space_in">                <div class="state_table_div load_page">                    <h2>ORIGIN STATE (Choose upto 3)</h2>                    <div class="ul_width_div">                        <?php                                $states = $wpdb->get_results("SELECT * from wp_statemaster ORDER BY state_full_name ASC");                                                                   if(!empty($states)){                                    $state_counter = 0;                                    $state_area = '';                                    foreach ($states as $state){                                        $class = ($state_counter % 2 == 0)?'class="alternate_row"':'';                                        if($state_counter == 0){                                            echo '<ul class="ul_width">';                                        }                            ?>                                        <li <?php echo $class;?>>                                            <div class="state_table_li_width">                                                <input name="o_state[]" type="checkbox" value="<?php echo $state->state_short_name; ?>" <?php if(isset($o_state) && in_array($state->state_short_name, $o_state)){echo 'checked';}?>>                                                <label><?php echo $state->state_full_name; ?></label>                                            </div>                                        </li>                            <?php                                        if($state_counter == 12){                                            echo '</ul>';                                        }                                        $state_counter++;                                        if($state_counter == 13){                                            $state_counter = 0;                                        }                                    }                                 }                            ?>                    </div>                </div>                <div class="state_table_div load_page">                    <h2>DESTINATION STATE</h2>                    <div class="ul_width_div">                        <?php                                $states = $wpdb->get_results( "SELECT * from wp_statemaster ORDER BY state_full_name ASC");                                                                   if(!empty($states)){                                    $state_counter = 0;                                    $state_area = '';                                    foreach ($states as $state){                                        $class = ($state_counter % 2 == 0)?'class="alternate_row"':'';                                        if($state_counter == 0){                                            echo '<ul class="ul_width">';                                        }                            ?>                                        <li <?php echo $class;?>>                                            <div class="state_table_li_width">                                                <input name="d_state[]" type="checkbox" value="<?php echo $state->state_short_name; ?>" <?php if(isset($d_state) && in_array($state->state_short_name, $d_state)){echo 'checked';}?>>                                                <label><?php echo $state->state_full_name; ?></label>                                            </div>                                        </li>                            <?php                                        if($state_counter == 12){                                            echo '</ul>';                                        }                                        $state_counter++;                                        if($state_counter == 13){                                            $state_counter = 0;                                        }                                    }                                 }                            ?>                    </div>                </div>            </div>        </div>        <div class="post_space">            <div class="post_space_in">                <div class="post_div_btm_area">                     <p><label>comments</label><textarea name="comments" id="comments" class="pst_area post_loads_txtarea2"><?php if(isset($comments)){echo $comments;}?></textarea></p>                </div>            </div>        </div>                <?php                    $query = "  SELECT                                     pm.*, pa.*                                 FROM                                     wp_post_package_master AS pm                                 INNER JOIN                                     wp_user_postaccount AS pa                                 ON                                     pm.id_post_package = pa.id_package                                 WHERE                                     pa.id_user = $user_id                                 AND                                     pa.expiry_date >= CURDATE()                                 AND                                     pa.post_count > 0                                ORDER BY                                     pa.expiry_date                                ASC                                ";                    $purchased_packages = $wpdb->get_results($query, ARRAY_A);                    if(!empty($purchased_packages)){                        foreach ($purchased_packages as $purchased_package) {?>                        <input type="hidden" name="purchased_package_id" id="purchased_package_id" value="<?php if(isset($purchased_package['id'])){echo $purchased_package['id'];}?>">                <?php                            break;                            }                        }                ?>                <div class="post_btn1">                    <input type="hidden" name="id" id="id" value="<?php if(isset($_REQUEST['post_id'])){echo $_REQUEST['post_id'];}?>">                    <input type="hidden" name="post_type" id="post_type" value="spaces">                    <input name="post_space_now" type="submit" value="POST SPACE NOW" class="search_btn1_post">                </div>            </form>        </div>    </div>    <!--cnt_div-end--></div><?php get_footer(); ?>