<?php/* Template Name:Find Loads */global $wpdb, $user_ID;//$o_extend = 14;//$d_extend = 14;if(isset($_REQUEST['search_loads'])){    $errmsg = '';    if(empty($_REQUEST['o_state'])){        $errmsg .= 'Please select at least one origin state.<br/>';    }    else if(empty($_REQUEST['pickup_start_date'])){        $errmsg .= 'Please enter a pickup start date.<br/>';    }    else if(empty($_REQUEST['pickup_end_date'])){        $errmsg .= 'Please enter a pickup end date.<br/>';    }    else if($_REQUEST['pickup_start_date'] >= $_REQUEST['pickup_end_date']){        $errmsg .= 'Pickup between start date should come before pickup between end date.<br/>';    }    else if(empty($_REQUEST['d_state'])){        $errmsg .= 'Please select at least one destination state.<br/>';    }    else if(empty($_REQUEST['delivery_start_date'])){        $errmsg .= 'Please enter a delivery start date.<br/>';    }    else if(empty($_REQUEST['delivery_end_date'])){        $errmsg .= 'Please enter a delivery end date.<br/>';    }    else if($_REQUEST['delivery_start_date'] >= $_REQUEST['delivery_end_date']){        $errmsg .= 'Delivery between start date should come before delivery between end date.<br/>';    }    else if($_REQUEST['pickup_start_date'] > $_REQUEST['delivery_start_date']){        $errmsg .= 'Pickup between start date should come before delivery between start date.<br/>';    }    if($errmsg == ''){        $pickup_start_date = str_replace('-','/',$_REQUEST['pickup_start_date']);        $pickup_end_date = str_replace('-','/',$_REQUEST['pickup_end_date']);        $delivery_start_date = str_replace('-','/',$_REQUEST['delivery_start_date']);        $delivery_end_date= str_replace('-','/',$_REQUEST['delivery_end_date']);//        $o_extend = $_REQUEST['o_extend'];//        $d_extend = $_REQUEST['d_extend'];        $master_query = "SELECT * FROM wp_loads WHERE 1=1";        if(!empty($_REQUEST['o_state'])){            $str_origin_states = implode(',', $_REQUEST['o_state']);            $master_query .= " AND o_state IN ('".$str_origin_states."')";        }        if(!empty($_REQUEST['d_state'])){            $str_destination_states = implode(',', $_REQUEST['d_state']);            $master_query .= " AND d_state IN ('".$str_destination_states."')";        }        if($pickup_start_date != '' && $pickup_end_date != ''){            if(isset($_REQUEST['o_extend'])){                $origin_start_date = date('Y-m-d', strtotime($pickup_start_date .' -'.$_REQUEST['o_extend'].' day'));                $origin_end_date= date('Y-m-d', strtotime($pickup_end_date .' +'.$_REQUEST['o_extend'].' day'));                $master_query .= " AND o_date BETWEEN '".$origin_start_date."' AND '".$origin_end_date."'";            }else{                $master_query .= " AND o_date BETWEEN '".date('Y-m-d', strtotime($pickup_start_date))."' AND '".date('Y-m-d', strtotime($pickup_end_date))."'";            }        }        if($delivery_start_date != '' && $delivery_end_date != ''){            if(isset($_REQUEST['d_extend'])){                $destination_start_date = date('Y-m-d', strtotime($delivery_start_date .' -'.$_REQUEST['d_extend'].' day'));                $destination_end_date= date('Y-m-d', strtotime($delivery_end_date .' +'.$_REQUEST['d_extend'].' day'));                $master_query .= " AND d_date BETWEEN '".$destination_start_date."' AND '".$destination_end_date."'";            }else{                $master_query .= " AND d_date BETWEEN '".date('Y-m-d', strtotime($delivery_start_date))."' AND '".date('Y-m-d', strtotime($delivery_end_date))."'";            }        }        if(!isset($_REQUEST['order_by'])){            $master_query .= " ORDER BY o_date";        }else{            $master_query .= " ORDER BY ".$_REQUEST['order_by'];        }        if(!isset($_REQUEST['order'])){            $order = 'DESC';            $master_query .= " $order";        }else{            if($_REQUEST['order'] == 'DESC'){                $order = 'ASC';            }else{                $order = 'DESC';            }            $master_query .= " ".$order;        }        $results = $wpdb->get_results($master_query, ARRAY_A);        $records = $wpdb->num_rows;    }}get_header(); ?><script type="text/javascript">$(function() {    $( ".datepicker" ).datepicker({        showOn: "button",        buttonImage: "<?php echo get_template_directory_uri();?>/images/img_3.png",        buttonImageOnly: true,        dateFormat: "mm-dd-yy"    });});</script>  <div class="ctn">            <!--contain-->            <?php                if(isset($results)){                    foreach($_REQUEST as $k=>$v){                        if(is_array($v)){                            foreach ($v as $value) {                                $request_str .= "$k"."[]=$value&";                            }                        }else{                            if($k!="order_by" && $k!="order"){                                $request_str .="$k=$v&";                            }                        }                    }                    $request_str = substr($request_str,0,strlen($request_str)-1);            ?>                    <div class="ctn_div_2">                        <div class="ctn_div_2_h2_head">                            <h2>RESULTS</h2>                        </div>                        <div class="table_div2">                            <table class="table_main">                              <tr class="fst_tr">                                <td><a href="<?php echo $_SREVER['PHP_SELF'];?>?<?php echo $request_str;?>&order_by=o_state&order=<?php echo $order;?>">Origin <br>State</a></td>                                <td><a href="<?php echo $_SREVER['PHP_SELF'];?>?<?php echo $request_str;?>&order_by=o_date&order=<?php echo $order;?>">P/U Date</a></td>                                <td><a href="<?php echo $_SREVER['PHP_SELF'];?>?<?php echo $request_str;?>&order_by=d_state&order=<?php echo $order;?>">Dest.<br> State</a></td>                                <td><a href="<?php echo $_SREVER['PHP_SELF'];?>?<?php echo $request_str;?>&order_by=d_date&order=<?php echo $order;?>">Delivery <br>Date</a></td>                                <td><a href="<?php echo $_SREVER['PHP_SELF'];?>?<?php echo $request_str;?>&order_by=o_loadsize&order=<?php echo $order;?>">Load SIZE<br>(cu. ft)</a></td>                                <td><a href="#">Vendor<br> Rating</a></td>                                <td class="more_div">More <br>Info</td>                              </tr>                              <?php                                    if(!empty($results)){                                        $i = 0;                                        foreach ($results as $result) {                              ?>                                    <tr class="<?php echo ($i%2 != 0)? 'tr_2nd':'tr_3rd';?>">                                      <td><a href="<?php echo site_url();?>/view-open-single-post/?id=<?php echo $result['id']; ?>&pt=<?php echo $result['post_type'] ?>"><?php echo $result['o_state'];?></a></td>                                      <td><a href="<?php echo site_url();?>/view-open-single-post/?id=<?php echo $result['id']; ?>&pt=<?php echo $result['post_type'] ?>"><?php echo date('m-d-Y', strtotime($result['o_date']));?></a></td>                                      <td><a href="<?php echo site_url();?>/view-open-single-post/?id=<?php echo $result['id']; ?>&pt=<?php echo $result['post_type'] ?>"><?php echo $result['d_state'];?></a></td>                                      <td><a href="<?php echo site_url();?>/view-open-single-post/?id=<?php echo $result['id']; ?>&pt=<?php echo $result['post_type'] ?>"><?php echo date('m-d-Y', strtotime($result['d_date']));?></a></td>                                      <td><a href="<?php echo site_url();?>/view-open-single-post/?id=<?php echo $result['id']; ?>&pt=<?php echo $result['post_type'] ?>"><?php echo $result['o_loadsize'];?></a></td>                                      <td>                                          <?php echo print_star_ratings($result['post_type'], $result['id']);?>                                      </td>                                      <td><a href="<?php echo site_url();?>/view-open-single-post/?id=<?php echo $result['id']; ?>&pt=<?php echo $result['post_type'] ?>"><input name="read_more" type="button" value="Read more" class="tbl_read_more_btn"></a></td>                                    </tr>                              <?php                                $i++;   }                               }else{ ?>                                    <tr class="tr_2nd">                                      <td colspan="7">No Results Found.</td>                                    </tr>                            <?php   } ?>                        </table>                        </div>                    </div>                    <?php } ?>            <div class="contain_main">            	<div class="ctn_in">            	<h1>FIND LOADS</h1>                <div class="clear"></div>            <?php                if(isset($errmsg)){?>                <p class="err_msg"><?php echo $errmsg;?></p>            <?php } ?>                <form name="search_loads" id="search_loads" action="" method="GET">                     <div class="state_table_div load_page">                                            <h2>ORIGIN STATE</h2>                        <div class="ul_width_div">                            <?php                                $states = $wpdb->get_results("SELECT * from wp_statemaster ORDER BY state_full_name ASC");                                                                   if(!empty($states)){                                    $state_counter = 0;                                    $state_area = '';                                    foreach ($states as $state){                                        $class = ($state_counter % 2 == 0)?'class="alternate_row"':'';                                        if($state_counter == 0){                                            echo '<ul class="ul_width">';                                        }                            ?>                                        <li <?php echo $class;?>>                                            <div class="state_table_li_width">                                                <input name="o_state[]" type="checkbox" value="<?php echo $state->state_short_name; ?>" <?php if(isset($_REQUEST['o_state']) && in_array($state->state_short_name, $_REQUEST['o_state'])){echo 'checked';}?>>                                                <label><?php echo $state->state_full_name; ?></label>                                            </div>                                        </li>                            <?php                                        if($state_counter == 12){                                            echo '</ul>';                                        }                                        $state_counter++;                                        if($state_counter == 13){                                            $state_counter = 0;                                        }                                    }                                 }                            ?>	                        </div>                </div>                <div class="state_table_bottom_div load_2">                    <p>                        <label>Pickup Between</label><br/>                        <input name="pickup_start_date" type="text" autocomplete="off" readonly class="state_table_bottom_select_box datepicker" value="<?php if($_REQUEST['pickup_start_date']){echo $_REQUEST['pickup_start_date'];}?>" />                        <label>To</label>                        <input name="pickup_end_date" type="text" autocomplete="off" readonly class="state_table_bottom_select_box datepicker" value="<?php if($_REQUEST['pickup_end_date']){echo $_REQUEST['pickup_end_date'];}?>" /><br/>                    </p>                </div>                <div class="state_table_div load_page">                	<h2>DESTINATION STATE</h2>                        <div class="ul_width_div">                            <?php                                $states = $wpdb->get_results( "SELECT * from wp_statemaster ORDER BY state_full_name ASC");                                                                   if(!empty($states)){                                    $state_counter = 0;                                    $state_area = '';                                    foreach ($states as $state){                                        $class = ($state_counter % 2 == 0)?'class="alternate_row"':'';                                        if($state_counter == 0){                                            echo '<ul class="ul_width">';                                        }                            ?>                                        <li <?php echo $class;?>>                                            <div class="state_table_li_width">                                                <input name="d_state[]" type="checkbox" value="<?php echo $state->state_short_name; ?>" <?php if(isset($_REQUEST['d_state']) && in_array($state->state_short_name, $_REQUEST['d_state'])){echo 'checked';}?>>                                                <label><?php echo $state->state_full_name; ?></label>                                            </div>                                        </li>                            <?php                                        if($state_counter == 12){                                            echo '</ul>';                                        }                                        $state_counter++;                                        if($state_counter == 13){                                            $state_counter = 0;                                        }                                    }                                 }                            ?>                        </div>                </div>                <div class="state_table_bottom_div load_2">                    <p>                        <label>Delivery Between</label><br/>                        <input name="delivery_start_date" type="text" autocomplete="off" readonly class="state_table_bottom_select_box datepicker" value="<?php if($_REQUEST['delivery_start_date']){echo $_REQUEST['delivery_start_date'];}?>" />                        <label>To</label>                        <input name="delivery_end_date" type="text" autocomplete="off" readonly class="state_table_bottom_select_box datepicker" value="<?php if($_REQUEST['delivery_end_date']){echo $_REQUEST['delivery_end_date'];}?>" /><br/>                    </p>                </div>                     <div class="load_btn"><input name="search_loads" type="submit" value="Search Now" class="search_btn1" /></div>                </form>                </div>            </div>            <!--cnt_div-end-->            <!--cnt_div_2-->                <!--cnt_div_2-end-->    </div><?php get_footer(); ?>